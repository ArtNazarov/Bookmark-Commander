<!-- 
  Bookmark Commander by Tom J Demuyt is licensed under a Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License.
  Permissions beyond the scope of this license are available by contacting konijn@gmail.com
 -->
<!DOCTYPE hmtl>
<html>
 <head>
  <title> Bookmark Commander </title>

  <meta http-equiv="content-type" content="text/html; charset=utf8">

  <meta name="Author" content="Tom J Demuyt">
  <meta name="Keywords" content="Bookmarks">

  <script type="text/javascript" src="jquery.1.6.js"></script> 

  <SCRIPT LANGUAGE="JavaScript">
  
    //Not sure whether this should be in bc.js or here..
    var screenwidth = 120;
    var panelwidth  = ( screenwidth - 4 ) / 2
    var panelheight = 30
  
  </SCRIPT>
  
  <script type="text/javascript" src="bc.js"></script> 
  <script type="text/javascript" src="viewer.js"></script> 
  <script type="text/javascript" src="editor.js"></script>   
  <link type="text/css" rel="stylesheet" href="bc.css" />   
  
 </head>

 <body style="font-family: Vera;">

<!-- These codes were retrieved from http://www.utf8-chartable.de/unicode-utf8-table.pl ( box drawing ) 
 ┌─┬─┐  ╔═╦═╗
 ├─┼─┤  ╠═╬═╣
 │ │ │  ║ ║ ║
 └─┴─┘  ╚═╩═╝
 -->

<pre>
<script>

    //Menu
	  document.writeln( "<span class='menu'>" + ("  Left     File     Command     Options     Right").extend() + "</span>" );
	  //Box Top
    document.writeln( "<span class='border'><span id='h1'>" + ( "╔" + "═".repeat(panelwidth) + "╗").repeat(2) + "</span>" ); //Missing span here !, it's below now

    //Entries
    for( var counter = 0 ; counter < panelheight ; counter++ )
    {
      document.write(   "║<span id='left" + counter + "' class='border'>" + " ".repeat(panelwidth) + "</span>║" ); 
      document.writeln( "║<span id='rite" + counter + "' class='border'>" + " ".repeat(panelwidth) + "</span>║" ); 
    }

    //Box Bottom
    document.writeln(  "<span id='h2'>╠" + "═".repeat(panelwidth) + "╩╩" + "═".repeat(panelwidth) + "╣</span>" ); 
    document.writeln(  "║<span id='url'>" + " ".repeat((panelwidth+1)*2) + "</span>║" ); 
    document.writeln(  "<span id='h3'>╚" + "═".repeat((panelwidth+1)*2) + "╝" + "</span></span>" ); 

    var function_keys = 
    [
      { id : 1 ,  description : "Help  " },
      { id : 2 ,  description : "Menu  " },
      { id : 3 ,  description : "View  " },
      { id : 4 ,  description : "Edit  " },
      { id : 5 ,  description : "Copy  " },
      { id : 6 ,  description : "Move  " },
      { id : 7 ,  description : "Mkdir " },
      { id : 8 ,  description : "Delete" },
      { id : 9 ,  description : "PullDn" },
      { id : 10 , description : "Quit  " },
    ];


    for( key in function_keys )
    {
      var f = function_keys[key];
      document.write( "<span class='fcode'>F" + f.id + "</span><span class='menu' id='f" + f.id + "'>" + f.description + "</span><span class='fcode'> </span>" );
    }
    document.writeln( "<span id='end' class='fcode'>" + " ".repeat( screenwidth - 91 ) + "</span>" );

</script>

</body>

<script>

var commander   = {};
var key_mapping = {};

$(document).ready(function () {

  commander.left  = { id : "0" , selected : 0  , scroll : 0 , active : true  , prefix : "left" };
  commander.right = { id : "0" , selected : 0  , scroll : 0 , active : false , prefix : "rite" };
  commander.bookmarks = {};
  commander.viewing = false;
  commander.editing = false;

  commander.setPanel = function( panelConfig )
  {
    var o = findBookmarkId( commander.bookmarks , panelConfig.id );

    //Are we clear ?
    if( !document.getElementById("end") )
      return;

    //Deal with trouble
    if( !o || !o.children )
    {
      //If we are looking at a dead folder by any chance, just go to the root
      if( panelConfig.id != "0" )
      {
        panelConfig.id = "0";
        commander.setPanel( panelConfig );
        return;
      }
      else
      {
        alert("Bookmark Commander regrets to inform you that it cannot display your bookmarks,\n please hit refresh and try again.");
      }
    }


    //Clear out the children
    for( var counter = 0 ; counter < panelheight ; counter++ )
    {
      document.getElementById( panelConfig.prefix + counter ).innerHTML = ( " ".repeat(panelwidth) );
      document.getElementById( panelConfig.prefix + counter ).setAttribute("class", "border" );
    }

    //We merely do this to facilitate the following trick
    var children = [].concat( o.children );

    //Do we have a parent ?, if so top the entries with '..'
    if( o.parentId )
    {
      children.reverse();
      children.push( { children: true , title : ".." , id : o.parentId } );
      children.reverse();
    }

    //Other parties are interested in how many items there really are
    panelConfig.itemcount = children.length;

    //Keep counter post-loop for sanity checks
    var counter;

    //Go over the children ( folders + bookmarks )
    for( counter = 0; counter < panelheight && counter < children.length ;counter++)
    {
      //Get the child
      var child  = children[counter+panelConfig.scroll];
      //Default bookmark prefix and style
      var prefix = " ";
      var style  = "border";

      //If there are no children though, take out the slash
      if( child.children )
        prefix = "/";

      //Are we looking at a javascript ?
      if( child.url && child.url.startsWith( "javascript" ) )
        style = "js"

      //If we look at the selected one the style is different
      if( counter == panelConfig.selected && panelConfig.active )
      {
        style = "selected"
        //Lets also show the url
        if( child.url )
        {
          var url = child.url.left( ((panelwidth+1)*2) ).extend( (panelwidth+1)*2 );
          document.getElementById( "url" ).innerHTML = url;
        }
        else
        {
          document.getElementById( "url" ).innerHTML = " ".repeat((panelwidth+1)*2);
        }
      }

      //Get the element
      var element = document.getElementById( panelConfig.prefix + counter );
    
      //set the style
      element.setAttribute("class", style );

      //Set the content
      element.innerHTML =  ( prefix + child.title ).extend( panelwidth );

      //Set the new index
      element.commander = { id : child.id };
    }
    //Since speed is of no concern, I just redraw the screen if we missed the selected item due to deletion ;)
    if( panelConfig.selected >= counter )
      commander.end();

  }
  /* HELPER, DRAW IT */
  commander.draw = function()
  {
    commander.setPanel( commander.left );
    commander.setPanel( commander.right );
  }

  /* TAB, SWAP */
  commander.swapPanel = function()
  {
    commander.left.active  = !commander.left.active;
    commander.right.active = !commander.right.active;
    commander.draw();
  }

  /* Prelude to SELECT, ENTER */
  commander.delve = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;
  
    var id = document.getElementById( panel.prefix + panel.selected ).commander.id;
  
    commander.select( id );
  }

  /* SELECT, ENTER */
  commander.select = function( index )
  {
    var panel = commander.left.active ? commander.left : commander.right;

    //Do we want to select this for real ?
    var bookmark = findBookmarkId( commander.bookmarks , index );
    //Go deeper if its a folder, or as the case may be, higher
    if( bookmark.children )
    {
      panel.id = index;
      panel.selected = 0;
      panel.scroll = 0;
      commander.draw();
    }
    //Open if its a bookmark
    else if( bookmark.url && bookmark.url.startsWith( [ "http" , "file" ] ) )
    {
      chrome.tabs.create( { 'url': bookmark.url }, null );
    }
    //Yes, do nuttin if its js, them evil hackers cannought be trusted
  }

  /* HELP */
  commander.help = function()
  {
    chrome.tabs.create( {'url': chrome.extension.getURL('help.html')}, null );
  }

  /* QUIT */
  commander.quit = function()
  {
    chrome.tabs.getCurrent( function( tab ) { chrome.tabs.remove( tab.id ) } );
  }

  /* VIEW */
  commander.view = function()
  {
    commander.viewing = !commander.viewing;

    if( commander.viewing )
    {
      commander.backup = document.body.innerHTML;
	  
	  var panel = commander.left.active ? commander.left : commander.right;
      var id = document.getElementById( panel.prefix + panel.selected ).commander.id;
	   	  
      viewer.view( id );
    }
    else
    {
      document.body.innerHTML = commander.backup;
	  
	  //we require it for decorating the elements, kludgy, I know
	  commander.draw();
	  
	  key_mapping = commander.key_mapping;
    }
  }
  
  /* EDIT */
  commander.edit = function()
  {
      commander.backup = document.body.innerHTML;
	  
	  var panel = commander.left.active ? commander.left : commander.right;
      var id = document.getElementById( panel.prefix + panel.selected ).commander.id;
	   	  
      editor.view( id );
  }  


  /* BACKSPACE */
  commander.back = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;
  
    var element = document.getElementById( panel.prefix + "0" );
    var text = jQuery.trim( element.innerHTML );

    if( text == "/.." )
      commander.select( element.commander.id );
  }

  /* DOWN */
  commander.down = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;

    if( panel.selected == panelheight-1  )
      panel.scroll++;
    else
      panel.selected++;

    if( !(panel.scroll + panel.selected < panel.itemcount) )
      commander.end();

    commander.draw();
  }

  /* UP */
  commander.up = function()
  {
    //Get active panel
    var panel = commander.left.active ? commander.left : commander.right;
    //if we are already physically in slot 0, see if we can still scroll up
    //Otherwise go up a physical slot
    if( panel.selected == 0 )
      panel.scroll--;
    else
      panel.selected--;
    //Sanity fix the scroll value
    if( panel.scroll == -1 )
      panel.scroll = 0
    //Draw the commander again
    commander.draw();
  }

  /* HOME */
  commander.home = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;
    panel.selected = 0;
    panel.scroll = 0;
    commander.draw();
  }

  /* END */
  commander.end = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;

    if( panel.itemcount < panelheight+1 )
    {
      panel.scroll = 0;
      panel.selected = panel.itemcount-1;
    }
    else
    {
      panel.scroll = panel.itemcount - panelheight;
      panel.selected = panelheight-1;
    }
    commander.draw();
  }

  /* COPY */
  commander.copy = function()
  {
    var from =  commander.left.active ? commander.left : commander.right;
    var to   = !commander.left.active ? commander.left : commander.right;
  
    if( to.id == "0" )
    {
      alert( "Can not copy bookmarks into the root" )
      return
    }
  
    //Copying from
    var from_id  = document.getElementById( from.prefix + from.selected ).commander.id;
    var bookmark = findBookmarkId( commander.bookmarks , from_id );

    var newbookmark = { parentId : to.id };
    //Create the bookmark object
    if( bookmark.title )
      newbookmark.title = bookmark.title;
    if( bookmark.url )
      newbookmark.url = bookmark.url;

    chrome.bookmarks.create( newbookmark , bootCommander );
  }

  /* MOVE */
  commander.move = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;
    var id  = document.getElementById( panel.prefix + panel.selected ).commander.id;
    var bookmark = findBookmarkId( commander.bookmarks , id );

    var to   = !commander.left.active ? commander.left : commander.right;

    if( to.id == "0" )
    {
      alert( "Can not copy bookmarks into the root" )
      return false
    }
   
    chrome.bookmarks.move( bookmark.id, { parentId  : to.id }  , bootCommander );
  }

  /* DELETE */
  commander.delete = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;
    var id  = document.getElementById( panel.prefix + panel.selected ).commander.id;
    var bookmark = findBookmarkId( commander.bookmarks , id );

    //What is interesting, is that removeTree works on non-trees as well
    //I am not going to count on that though ;]
    if( bookmark.children )
      chrome.bookmarks.removeTree( bookmark.id , bootCommander );
    else
      chrome.bookmarks.remove( bookmark.id , bootCommander );
  }

  /* CREATE FOLDER */
  commander.createfolder = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;
    var foldertext = prompt("Enter folder name","");

    if(foldertext)
    {
      var newbookmark = { parentId : panel.id , title : foldertext };
      chrome.bookmarks.create( newbookmark , bootCommander );
    }  
  }

  /* PLUS , MOVE UP */
  commander.moveup = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;
    var id  = document.getElementById( panel.prefix + panel.selected ).commander.id;
    var bookmark = findBookmarkId( commander.bookmarks , id );

    if( panel.id == 0 )
      return;

    if( panel.selected == 0 && panel.scroll == 0 )
      return;

    if( bookmark.index == 0 )
      return;
    
    if( panel.selected == 0 )
      panel.scroll--;
    else
      panel.selected--;

    chrome.bookmarks.move( id, { parentId: panel.id , index : (bookmark.index-1)   }  , bootCommander );
  
  }

  /* DOWN, MOVE DOWN */
  commander.movedown = function()
  {
    var panel = commander.left.active ? commander.left : commander.right;
    var id  = document.getElementById( panel.prefix + panel.selected ).commander.id;
    var bookmark = findBookmarkId( commander.bookmarks , id );

    if( panel.id == 0 )
      return;

    if( panel.selected == 0 && panel.scroll == 0 )
      return;

    //no see who is under their
    var parent   = findBookmarkId( commander.bookmarks , panel.id );
    var bookmark = parent.children[ bookmark.index+1 ];
    if( bookmark )
    {
      //We are evilly counting on the 'hmmm I think this got deleted feature', muhaha is in order
      if( panel.selected == panelheight-1 )
        panel.scroll++;
      else
        panel.selected++;

      chrome.bookmarks.move( bookmark.id , { parentId: panel.id , index : (bookmark.index-1)   }  , bootCommander );
    }
  }


  /* INIT, RE-INIT */
  function bootCommander()
  {
    chrome.bookmarks.getTree( function(stuff)
    { 
      commander.bookmarks = stuff ;
      commander.draw();
    });
  }
  bootCommander()
  
  /* EVIL Mac Fix */
  if( navigator.userAgent.has( "Mac" ) )
  {
	//Replace ═ with =, cause silly Mac OS
	$("#h1").text( function(index, oldtext) { return oldtext.replace( /═/gi , "=" ) });
	$("#h2").text( function(index, oldtext) { return oldtext.replace( /═/gi , "=" ) });  
  	$("#h3").text( function(index, oldtext) { return oldtext.replace( /═/gi , "=" ) });
  }
  
  //Key mappings
  //Start with the viewer
  key_mapping = {};
  key_mapping[112] = commander.help;    //F1
  key_mapping[114] = commander.view;    //F3
  key_mapping[121] = commander.view;    //F10 ( yes, the same )
  key_mapping[116] = viewer.test;			  //F5
  key_mapping[13]  = viewer.test;			  //Enter  
  viewer.key_mapping = key_mapping;  

  //Start with the viewer
  key_mapping = {};
  key_mapping[112] = commander.help;    //F1
  key_mapping[113] = editor.save;       //F2
  key_mapping[115] = editor.quit;       //F4  
  key_mapping[116] = editor.test;			  //F5
  key_mapping[121] = editor.quit;			  //F10 ( yes, the same )
  editor.key_mapping = key_mapping;  
  
  //Now do the commander key mappings
  key_mapping = {};
  key_mapping[8 ] =  commander.back;           //backspace
  key_mapping[9 ] =  commander.swapPanel;      //tab
  key_mapping[13] =  commander.delve;          //enter
  key_mapping[40] =  commander.down;           //Arrow Down
  key_mapping[38] =  commander.up;             //Arrow Up
  key_mapping[36] =  commander.home;           //Home key
  key_mapping[35] =  commander.end;            //End key
  key_mapping[112] = commander.help;          //F1
  key_mapping[114] = commander.view;          //F3
  key_mapping[115] = commander.edit;          //F4
  key_mapping[116] = commander.copy;          //F5
  key_mapping[117] = commander.move;          //F6
  key_mapping[118] = commander.createfolder;  //F7
  key_mapping[119] = commander.delete;        //F8
  key_mapping[121] = commander.quit;          //F10
  key_mapping[107] = commander.moveup;        //+ on numeric
  key_mapping[187] = commander.moveup;        //+ on main
  key_mapping[109] = commander.movedown;      //- on numeric
  key_mapping[189] = commander.movedown;      //- on main
  
  commander.key_mapping = key_mapping;

  control_key_mapping = {};
  control_key_mapping[79] = commander.showLogs;
  
  
  //Escape function keys are mostly meant for the evil mac that hijacks F keys
  //My brain is so hard wired to Escape 0 for quit that I even do this on Windows now
  escape_mapping = {};
  //49 is keyboard 1 , 58 is one above keyboard 9
  //112 is F1, 113 is F2 etc
  for( var counter = 49 ; counter < 58 ; counter++ )
    escape_mapping[counter] = (112-49)+counter; //1 ->F1 till 9->F9
  escape_mapping[48] = 121; //0 -> F10 does not follow the pattern
  

  $(document).keydown( function( event )
  {
    document.getElementById("end").innerHTML = ("Key: " + event.which).extend( screenwidth - 91 );

    if( key_mapping.escape && event.which != 27)
    {
      if( escape_mapping[ event.which ] )
        event.which = escape_mapping[ event.which ];
    }
    
    if( key_mapping[ event.which ] )
    {
      key_mapping[ event.which ]();
      return false;
    }
    
    if( event.which == 27 )
      key_mapping.escape = true;
    
    return true;
  });

});


</script>


</html>